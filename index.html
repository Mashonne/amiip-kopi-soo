<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aggregate Results</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" /> -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto Mono:wght@400;700&display=swap"
    />
    <style>
      body {
        background-color: black;
        color: white;
        font-family: "Roboto Mono", monospace;
        min-height: 100vh;
      }
    </style>
  </head>
  <body>
    <div
      class="flex flex-col gap-[30px] sm:py-[50px] xl:py-[60px] py-[30px] px-[30px] sm:px-[60px] xl:px-[70px]"
    >
      <div
        class="flex justify-start gap-[20px] xl:justify-between flex-col xl:flex-row"
      >
        <!-- <span
          class="w-full text-[24px] sm:text-[30px] xl:text-[50px] flex-1 order-2 xl:order-1 xl:item-center"
        > -->
        <span
          class="w-full text-[24px] sm:text-[30px] xl:text-[3vw] font-semibold flex-1 order-2 xl:order-1 xl:item-center"
        >
          Can you identify <br />
          the AI imposter?
        </span>
        <div
          class="text-[20px] sm:text-[30px] order-1 xl:order-2 flex xl:justify-end"
        >
          <div class="w-2/3 flex xl:justify-end sm:w-[300px] xl:w-[25vw]">
            <img src="./logo.svg" alt="Image" />
          </div>
        </div>
      </div>
      <div
        class="flex w-full flex-col xl:flex-row justify-between gap-[20px] xl:items-start relative"
      >
        <div
          class="flex flex-col w-full gap-[20px] sm:gap-[30px] xl:gap-[1.2vw]"
        >
          <div class="flex justify-start">
            <span
              class="text-[10px] font-semibold sm:text-[16px] xl:text-[1vw] px-[7px] text-black bg-white"
            >
              TOTAL OUTCOMES
            </span>
          </div>
          <div class="flex justify-start mt-[20px]">
            <div class="w-full">
              <!-- <canvas id="resultsChart" height="110""></canvas> -->
              <canvas
                id="resultsChart"
                style="width: 100vw; height: 50vh"
              ></canvas>
            </div>
          </div>
          <div
            class="flex justify-evenly sm:justify-start gap-[5px] sm:gap-[30px]"
          >
            <div class="flex gap-[6px] items-center">
              <div
                class="rounded-full p-[6px] sm:p-[10px] xl:p-[0.65vw] bg-[#ffdc00]"
              ></div>
              <span class="text-[10px] sm:text-[16px]">Audio Results</span>
            </div>
            <div class="flex gap-[6px] items-center">
              <div
                class="rounded-full p-[6px] sm:p-[10px] xl:p-[0.65vw] bg-[#ff8200]"
              ></div>
              <span class="text-[10px] sm:text-[16px]">Video Results</span>
            </div>
            <div class="flex gap-[6px] items-center">
              <div
                class="rounded-full p-[6px] sm:p-[10px] xl:p-[0.65vw] bg-[#8a68c8]"
              ></div>
              <span class="text-[10px] sm:text-[16px]">Photo Results</span>
            </div>
          </div>
        </div>
        <div class="flex flex-col absolute right-[100px] xl:block hidden">
          <div>
            <span
              class="text-[10px] font-semibold sm:text-[16px] xl:text-[1vw] px-[7px] text-black bg-white"
            >
              LAST 20 MINUTES
            </span>
          </div>
          <div
            class="flex flex-row xl:flex-col gap-[10px] xl:gap-[1vw] mt-[20px]"
          >
            <div
              class="bg-[black] flex px-[10px] xl:px-[1vw] sm:px-[20px] flex-col w-full py-[5px] xl:w-[12vw] border-white border-[2px] xl:border-[0.15vw] rounded-[10px] xl:rounded-[1vw]"
            >
              <span class="text-[10px] sm:text-[16px] xl:text-[1vw] uppercase"
                >AMATEUR</span
              >
              <span
                class="text-[25px] sm:text-[40px] xl:text-[3.5vw] font-medium text-center"
                id="amateur"
              >
                -
              </span>
            </div>
            <div
              class="bg-[black] flex px-[10px] xl:px-[1vw] sm:px-[20px] flex-col w-full py-[5px] xl:w-[12vw] border-white border-[2px] xl:border-[0.15vw] rounded-[10px] xl:rounded-[1vw]"
            >
              <span class="text-[10px] sm:text-[16px] xl:text-[1vw] uppercase"
                >Trainee</span
              >
              <span
                class="text-[25px] sm:text-[40px] xl:text-[3.5vw] font-medium text-center"
                id="trainee"
              >
                -
              </span>
            </div>
            <div
              class="bg-[black] flex px-[10px] xl:px-[1vw] sm:px-[20px] flex-col w-full py-[5px] xl:w-[12vw] border-white border-[2px] xl:border-[0.15vw] rounded-[10px] xl:rounded-[1vw]"
            >
              <span class="text-[10px] sm:text-[16px] xl:text-[1vw] uppercase"
                >Pro</span
              >
              <span
                class="text-[25px] sm:text-[40px] xl:text-[3.5vw] font-medium text-center"
                id="pro"
              >
                -
              </span>
            </div>
          </div>
        </div>
      </div>
      <div
        class="flex flex-col gap-[20px] sm:gap-[30px] xl:gap-[1.1vw] xl:hidden block"
      >
        <div>
          <span
            class="text-[10px] font-semibold sm:text-[16px] xl:text-[1vw] px-[7px] text-black bg-white"
          >
            LAST 20 MINUTES
          </span>
        </div>
        <div class="flex flex-row xl:flex-col gap-[10px] xl:gap-[1vw]">
          <div
            class="bg-[black] flex px-[10px] xl:px-[1vw] sm:px-[20px] flex-col w-full py-[5px] xl:w-[12vw] border-white border-[2px] xl:border-[0.15vw] rounded-[10px] xl:rounded-[1vw]"
          >
            <span class="text-[10px] sm:text-[16px] xl:text-[1vw] uppercase"
              >AMATEUR</span
            >
            <span
              class="text-[25px] sm:text-[40px] xl:text-[3.5vw] font-medium text-center"
              id="amateur-sm"
            >
              -
            </span>
          </div>
          <div
            class="bg-[black] flex px-[10px] xl:px-[1vw] sm:px-[20px] flex-col w-full py-[5px] xl:w-[12vw] border-white border-[2px] xl:border-[0.15vw] rounded-[10px] xl:rounded-[1vw]"
          >
            <span class="text-[10px] sm:text-[16px] xl:text-[1vw] uppercase"
              >Trainee</span
            >
            <span
              class="text-[25px] sm:text-[40px] xl:text-[3.5vw] font-medium text-center"
              id="trainee-sm"
            >
              -
            </span>
          </div>
          <div
            class="bg-[black] flex px-[10px] xl:px-[1vw] sm:px-[20px] flex-col w-full py-[5px] xl:w-[12vw] border-white border-[2px] xl:border-[0.15vw] rounded-[10px] xl:rounded-[1vw]"
          >
            <span class="text-[10px] sm:text-[16px] xl:text-[1vw] uppercase"
              >Pro</span
            >
            <span
              class="text-[25px] sm:text-[40px] xl:text-[3.5vw] font-medium text-center"
              id="pro-sm"
            >
              -
            </span>
          </div>
        </div>
      </div>
    </div>
    <!-- <script>
      let chart;

      // Function to fetch data from Airtable
      async function fetchData() {
        const response = await fetch(
          "https://api.airtable.com/v0/appoOC9OGPSRRgACV/Table%201",
          {
            headers: {
              Authorization:
                "Bearer patFK6oNVppWSAEvw.3094966f5fcde47173d52773003596dff4ff9a391626e00ff8bdbc87067f6c15",
              "Content-Type": "application/json",
            },
          }
        );
        const data = await response.json();
        return data.records;
      }

      // Function to process and aggregate data
      function processResults(records) {
        const results = {
          image: { amateurs: 0, pros: 0, rookies: 0 },
          audio: { amateurs: 0, pros: 0, rookies: 0 },
          video: { amateurs: 0, pros: 0, rookies: 0 },
        };

        const now = new Date();
        const pastTime = new Date(now.getTime() - 20 * 60000); // 20 minutes ago

        let recentCounts = { amateurs: 0, pros: 0, rookies: 0 };

        records.forEach((record) => {
          const quizType = record.fields.Quiz;
          const resultName = record.fields.Result_name;
          const createdTime = new Date(record.createdTime);

          if (quizType && resultName) {
            if (resultName.includes("Amateur")) {
              results[quizType].amateurs++;
            } else if (resultName.includes("Pro")) {
              results[quizType].pros++;
            } else if (resultName.includes("Rookie")) {
              results[quizType].rookies++;
            }

            if (createdTime >= pastTime) {
              if (resultName.includes("Amateur")) {
                recentCounts.amateurs++;
              } else if (resultName.includes("Pro")) {
                recentCounts.pros++;
              } else if (resultName.includes("Rookie")) {
                recentCounts.rookies++;
              }
            }
          }
        });

        document.getElementById("amateur-count").textContent =
          recentCounts.amateurs;
        document.getElementById("rookie-count").textContent =
          recentCounts.rookies;
        document.getElementById("pro-count").textContent = recentCounts.pros;

        return results;
      }

      // Create chart data
      function createChartData(results) {
        return {
          labels: ["Amateur", "Trainee", "Pro"],

          datasets: [
            {
              label: "Audio",
              data: [
                results.audio.amateurs,
                results.audio.rookies,
                results.audio.pros,
              ],
              backgroundColor: "#FFDC00", // Yellow
              borderColor: "#FFDC00",
              borderWidth: 1,
            },
            {
              label: "Video",
              data: [
                results.video.amateurs,
                results.video.rookies,
                results.video.pros,
              ],
              backgroundColor: "#FF8200", // orange
              borderColor: "#FF8200",
              borderWidth: 1,
            },
            {
              label: "Photo",
              data: [
                results.image.amateurs,
                results.image.rookies,
                results.image.pros,
              ],
              backgroundColor: "#8A68C8", // Purple
              borderColor: "#8A68C8",
              borderWidth: 1,
            },
          ],
        };
      }

      // Chart options for better UX
      const options = {
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            display: false,
          },
          x: {
            ticks: {
              color: "white", // set x-axis label color to white
              font: {
                size: 25,
                family: "Roboto Mono",
                position: "left",
              },
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
        },
      };

      // Function to render Chart
      function renderChart(ctxId, chartData) {
        const ctx = document.getElementById(ctxId).getContext("2d");
        if (chart) {
          chart.destroy(); // Destroy the existing chart if it exists
        }
        chart = new Chart(ctx, {
          type: "bar",
          data: chartData,
          options: options,
        });
      }

      // Function to fetch data and update chart
      async function updateChart() {
        const records = await fetchData();
        const results = processResults(records);
        const chartData = createChartData(results);
        renderChart("resultsChart", chartData);
      }

      // Fetch and render the data when the window loads
      window.onload = function () {
        updateChart();
        setInterval(updateChart, 60000); // Update chart every 60 seconds (60000 milliseconds)
      };
    </script> -->
    <script>
      let chart;
      let oldChartData;

      async function fetchData() {
        const response = await fetch(
          "https://api.airtable.com/v0/appoOC9OGPSRRgACV/Table%201",
          {
            headers: {
              Authorization:
                "Bearer patFK6oNVppWSAEvw.3094966f5fcde47173d52773003596dff4ff9a391626e00ff8bdbc87067f6c15",
              "Content-Type": "application/json",
            },
          }
        );
        const data = await response.json();
        return data.records;
      }

      // Function to process and aggregate data
      function processResults(records) {
        const results = {
          image: { amateurs: 0, pros: 0, rookies: 0 },
          audio: { amateurs: 0, pros: 0, rookies: 0 },
          video: { amateurs: 0, pros: 0, rookies: 0 },
        };

        records.forEach((record) => {
          const quizType = record.fields.Quiz.toLowerCase();
          const resultName = record.fields.Result_name;

          if (quizType && resultName) {
            if (resultName.includes("Amateur")) {
              results[quizType].amateurs++;
            } else if (resultName.includes("Pro")) {
              results[quizType].pros++;
            } else if (resultName.includes("Rookie")) {
              results[quizType].rookies++;
            }
          }
        });

        return results;
      }

      // Create chart data
      function createChartData(results) {
        return {
          labels: ["Amateur", "Trainee", "Pro", ""],
          datasets: [
            {
              label: "Audio",
              data: [
                results.audio.amateurs,
                results.audio.rookies,
                results.audio.pros,
              ],
              backgroundColor: "#FFDC00",
              borderColor: "#FFDC00",
              borderWidth: 1,
            },
            {
              label: "Video",
              data: [
                results.video.amateurs,
                results.video.rookies,
                results.video.pros,
              ],
              backgroundColor: "#FF8200",
              borderColor: "#FF8200",
              borderWidth: 1,
            },
            {
              label: "Photo",
              data: [
                results.image.amateurs,
                results.image.rookies,
                results.image.pros,
              ],
              backgroundColor: "#8A68C8",
              borderColor: "#8A68C8",
              borderWidth: 1,
            },
          ],
        };
      }

      function calculateFontSize() {
        const screenWidth = window.innerWidth;

        // Tailwind breakpoints:
        // sm: 640px
        // md: 768px
        // lg: 1024px
        // xl: 1280px

        if (screenWidth >= 1280) {
          // xl and above
          return screenWidth * 0.011;
        } else if (screenWidth >= 640) {
          // sm to xl
          return 25;
        } else {
          // less than sm
          return 12;
        }
      }

      const options = {
        scales: {
          y: {
            ticks: {
              display: false,
              stepSize: 4,
            },
            grid: {
              color: "#B3B3B3",
            },
            border: {
              dash: [6, 6],
            },
          },

          x: {
            border: {
              color: "#B3B3B3",
            },
            ticks: {
              color: "#FFFFFF",
              font: {
                size: calculateFontSize(),
                family: "Roboto Mono",
              },
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
        },
        responsive: true,
        maintainAspectRatio: false,
        barPercentage: 0.8,
        categoryPercentage: 0.7,
      };

      function getTimeRangeData(apiData) {
        const currentDateTime = moment();
        const dateTime30MinutesAgo = moment().subtract(20, "minutes");

        const last20MinData = apiData.filter((d) =>
          moment(d.createdTime).isBetween(dateTime30MinutesAgo, currentDateTime)
        );

        return last20MinData.reduce(
          (acc, data) =>
            acc[data.fields.Result_name]
              ? {
                  ...acc,
                  [data.fields.Result_name]: acc[data.fields.Result_name] + 1,
                }
              : {
                  ...acc,
                  [data.fields.Result_name]: 1,
                },
          {}
        );
      }

      function renderChart(chartData) {
        const ctx = document.getElementById("resultsChart").getContext("2d");
        if (chart) {
          chart.destroy();
        }

        chart = new Chart(ctx, {
          type: "bar",
          data: chartData,
          options: options,
        });
      }

      function renderElements(apiData) {
        const result = getTimeRangeData(apiData);
        const { Amateur, Rookie, Pro } = result;

        const amateurElement = document.getElementById("amateur");
        const traineeElement = document.getElementById("trainee");
        const proElement = document.getElementById("pro");
        const amateurSmallElement = document.getElementById("amateur-sm");
        const traineeSmallElement = document.getElementById("trainee-sm");
        const proSmallElement = document.getElementById("pro-sm");

        amateurElement.innerHTML = "+" + (Amateur || 0);
        traineeElement.innerHTML = "+" + (Rookie || 0);
        proElement.innerHTML = "+" + (Pro || 0);

        amateurSmallElement.innerHTML = "+" + (Amateur || 0);
        traineeSmallElement.innerHTML = "+" + (Rookie || 0);
        proSmallElement.innerHTML = "+" + (Pro || 0);
      }

      async function updateChart() {
        const records = await fetchData();
        if (oldChartData === JSON.stringify(records)) {
          return;
        } else {
          oldChartData = JSON.stringify(records);
          const results = processResults(records);
          const chartData = createChartData(results);
          renderChart(chartData);
          renderElements(records);
        }
      }

      window.onload = function () {
        updateChart();
        setInterval(updateChart, 15000);
      };
    </script>
  </body>
</html>
